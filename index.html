<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notestrator</title>
    <script>
      const { ipcRenderer } = require("electron");
    </script>
  </head>
  <body>
    <svg
      style="
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      "
    ></svg>
    <script>
      const drawing = document.currentScript.previousElementSibling;
      let currentLine = null;
      let currentEraserRadius = null;
      window.addEventListener("mousedown", async (event) => {
        const menu = await ipcRenderer.invoke("menu--main");
        switch (menu.tool) {
          case "pen":
          case "marker":
            drawing.insertAdjacentHTML(
              "beforeend",
              `
            <polyline
              points="${event.x} ${event.y}"
              fill="none"
              stroke="${menu.color}"
              stroke-width="${
                menu.strokeWidth * (menu.tool === "marker" ? 3 : 1)
              }"
              stroke-opacity="${menu.tool === "marker" ? 0.5 : 1}"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          `
            );
            currentLine = drawing.lastElementChild;
            break;
          case "eraser":
            currentEraserRadius = menu.strokeWidth * 5;
            break;
        }
      });

      window.addEventListener("mousemove", (event) => {
        if (currentLine !== null)
          currentLine.setAttribute(
            "points",
            `${currentLine.getAttribute("points")}, ${event.x} ${event.y}`
          );

        if (currentEraserRadius !== null) {
          const elementsToRemove = new Set();
          for (const element of drawing.querySelectorAll("*"))
            switch (element.tagName) {
              case "polyline":
                for (const [x, y] of element
                  .getAttribute("points")
                  .split(",")
                  .map((point) => point.trim().split(" ")))
                  if (
                    Math.sqrt((event.x - x) ** 2 + (event.y - y) ** 2) <
                    currentEraserRadius
                  )
                    elementsToRemove.add(element);
                break;
            }

          for (const element of elementsToRemove) element.remove();
        }
      });

      window.addEventListener("mouseup", () => {
        currentLine = null;
        currentEraserRadius = null;
      });
    </script>
  </body>
</html>
