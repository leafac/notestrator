<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notestrator</title>
    <script>
      const { ipcRenderer } = require("electron");
    </script>
  </head>
  <body>
    <svg
      style="
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      "
    ></svg>
    <script>
      function dist(a, b) {
        return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
      }
      function slope(a, b) {
        return (b.y - a.y) / (b.x - a.x);
      }
      const drawing = document.currentScript.previousElementSibling;
      const smoothnessFactor = 0.5;
      const x0 = { x: 100, y: 300 };
      const x1 = { x: 300, y: 320 };
      const x2 = { x: 200, y: 400 };
      const distance_x0_x1 = Math.sqrt((x0.x - x1.x) ** 2 + (x0.y - x1.y) ** 2);
      const distance_x1_x2 = Math.sqrt((x1.x - x2.x) ** 2 + (x1.y - x2.y) ** 2);
      const distance_x0_x1_x2 = distance_x0_x1 + distance_x1_x2;
      const ratioBetween_distance_x0_x1__distance_x0_x1_x2 =
        distance_x0_x1 / distance_x0_x1_x2;
      const ratioBetween_distance_x1_x2__distance_x0_x1_x2 =
        distance_x1_x2 / distance_x0_x1_x2;
      const w = x2.x - x0.x;
      const h = x2.y - x0.y;

      const p1 = {
        x:
          x1.x -
          w * smoothnessFactor * ratioBetween_distance_x0_x1__distance_x0_x1_x2,
        y:
          x1.y -
          h * smoothnessFactor * ratioBetween_distance_x0_x1__distance_x0_x1_x2,
      };
      const p2 = {
        x:
          x1.x +
          w * smoothnessFactor * ratioBetween_distance_x1_x2__distance_x0_x1_x2,
        y:
          x1.y +
          h * smoothnessFactor * ratioBetween_distance_x1_x2__distance_x0_x1_x2,
      };

      drawing.insertAdjacentHTML(
        "beforeend",
        `
        <path
          d="
            M ${x0.x} ${x0.y}
            C ${x0.x} ${x0.y}, ${p1.x} ${p1.y}, ${x1.x} ${x1.y}
              ${p2.x} ${p2.y}, ${x2.x} ${x2.y}, ${x2.x} ${x2.y}
          "
          stroke="crimson"
          stroke-width="5"
          stroke-linecap="round"
          stroke-linejoin="round"
          fill="none"
        />
        <circle cx="${x0.x}" cy="${x0.y}" r="5" fill="blue" />
        <circle cx="${x1.x}" cy="${x1.y}" r="5" fill="blue" />
        <circle cx="${x2.x}" cy="${x2.y}" r="5" fill="blue" />

        <circle cx="${p1.x}" cy="${p1.y}" r="5" fill="purple" />
        <circle cx="${p2.x}" cy="${p2.y}" r="5" fill="purple" />
       `
      );
      window.addEventListener("mousedown", async (event) => {
        const menu = await ipcRenderer.invoke("menu");
        let handleMousemove;
        switch (menu.tool) {
          case "pen":
          case "marker":
            drawing.insertAdjacentHTML(
              "beforeend",
              `
                <polyline
                  points="${event.x} ${event.y}"
                  fill="none"
                  stroke="${menu.color}"
                  stroke-width="${
                    menu.strokeWidth * (menu.tool === "marker" ? 3 : 1)
                  }"
                  stroke-opacity="${menu.tool === "marker" ? 0.5 : 1}"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              `
            );
            const polyline = drawing.lastElementChild;
            handleMousemove = (event) => {
              polyline.setAttribute(
                "points",
                `${polyline.getAttribute("points")}, ${event.x} ${event.y}`
              );
            };
            break;
          case "eraser":
            handleMousemove = (event) => {
              const elementsToRemove = new Set();
              for (const element of drawing.querySelectorAll("*"))
                switch (element.tagName) {
                  case "polyline":
                    for (const [x, y] of element
                      .getAttribute("points")
                      .split(",")
                      .map((point) => point.trim().split(" ")))
                      if (
                        Math.sqrt((event.x - x) ** 2 + (event.y - y) ** 2) <
                        menu.strokeWidth * 5
                      )
                        elementsToRemove.add(element);
                    break;
                }

              for (const element of elementsToRemove) element.remove();
            };
            break;
        }
        window.addEventListener("mousemove", handleMousemove);
        window.addEventListener("mouseup", () => {
          window.removeEventListener("mousemove", handleMousemove);
        });
      });
    </script>
  </body>
</html>
